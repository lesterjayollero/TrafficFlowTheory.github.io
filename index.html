<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Greenshields Model — Interactive Demo</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      background: #f8f9fa;
      color: #222;
    }
    header {
      background: #004b8d;
      color: white;
      padding: 1.5em;
      text-align: center;
      line-height: 1.4em;
    }
    section {
      padding: 1.5em 2em;
      max-width: 950px;
      margin: auto;
    }
    h1, h2 {
      color: #004b8d;
    }
    .formula {
      background: #eef3f8;
      border-left: 4px solid #004b8d;
      padding: 1em;
      margin: 1em 0;
      font-family: "Consolas", monospace;
    }
    .road-container {
      position: relative;
      width: 100%;
      height: 180px;
      background: #444;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: inset 0 -4px 8px rgba(0,0,0,0.4);
      margin-top: 2em;
    }
    .lane-divider {
      position: absolute;
      top: 50%;
      width: 100%;
      height: 4px;
      background: repeating-linear-gradient(
        to right,
        #fff 0 20px,
        transparent 20px 40px
      );
      opacity: 0.7;
    }
    .car {
      position: absolute;
      width: 45px;
      height: 25px;
      border-radius: 4px;
      background: red;
      transform: translateY(-50%);
      top: 25%;
    }
    .car.lane2 {
      top: 75%;
      background: #2ecc71;
    }
    #controls {
      text-align: center;
      margin-top: 1.5em;
    }
    input[type=range] {
      width: 60%;
    }
    canvas {
      width: 100%;
      height: 300px;
    }
  </style>
</head>
<body>
  <header>
    <h1>TRAFFIC FLOW THEORY (Greenshields Fundamental Diagram)</h1>
    <p>Built for interactive demonstration of the Greenshields Traffic Flow Model.</p>
    <p><strong>Please cite as:</strong><br>
      Ollero, L. J. (2025). <em>Traffic Flow Theory: Greenshields Model Interactive Visualization.</em><br>
      Available at: <a href="https://lesterjayollero.github.io/TrafficFlowTheory.github.io" style="color:#fff;text-decoration:underline;">https://lesterjayollero.github.io/TrafficFlowTheory.github.io</a>
    </p>
  </header>

  <section>
    <h2>Model Formulation</h2>
    <div class="formula">
      <p><strong>Assumptions:</strong></p>
      <ul>
        <li>Uniform driver behavior.</li>
        <li>Steady, one-directional, uninterrupted traffic flow.</li>
        <li>Linear relationship between speed and density.</li>
      </ul>
      <p>
        Linear speed–density relationship:<br>
        \( u = u_f (1 - \frac{k}{k_j}) \)
      </p>
      <p>
        Flow–density relationship:<br>
        \( q = k \cdot u = u_f \left(k - \frac{k^2}{k_j}\right) \)
      </p>
      <p>
        Maximum flow (capacity):<br>
        \( q_{max} = \frac{u_f k_j}{4} \)
      </p>
    </div>

    <h2>Interactive Demonstration</h2>
    <p>
      Adjust the <strong>Operating Density</strong> to visualize how changes in vehicle density affect
      speed, flow, and congestion. The simulation below shows vehicles moving along a
      straight 2-lane road, with corresponding graphs of flow and speed.
    </p>

    <div id="controls">
      <label for="density">Operating Density (veh/km): </label>
      <input type="range" id="density" min="0" max="200" value="30" />
      <span id="densityValue">30</span>
    </div>

    <div class="road-container" id="road">
      <div class="lane-divider"></div>
    </div>

    <canvas id="chart"></canvas>

    <p style="font-size:0.9em; color:#555; margin-top:2em;">
      References: Greenshields, B. D. (1935). "A Study of Traffic Capacity." 
      <em>Highway Research Board Proceedings</em>, 14, 448–477.  
      May, A. D. (1990). <em>Traffic Flow Fundamentals</em>. Prentice Hall.
    </p>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const uf = 100;  // free-flow speed (km/h)
    const kj = 200;  // jam density (veh/km)
    const densitySlider = document.getElementById('density');
    const densityValue = document.getElementById('densityValue');
    const road = document.getElementById('road');

    // Chart.js setup
    const ctx = document.getElementById('chart').getContext('2d');
    const densities = Array.from({length: kj + 1}, (_, i) => i);
    const speeds = densities.map(k => uf * (1 - k / kj));
    const flows = densities.map((k, i) => k * speeds[i]);
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: densities,
        datasets: [
          {
            label: 'Speed (km/h)',
            data: speeds,
            borderColor: '#004b8d',
            borderWidth: 2,
            yAxisID: 'A',
          },
          {
            label: 'Flow (veh/h)',
            data: flows,
            borderColor: '#28a745',
            borderWidth: 2,
            yAxisID: 'B',
          }
        ]
      },
      options: {
        scales: {
          A: {
            type: 'linear',
            position: 'left',
            title: { display: true, text: 'Speed (u)' }
          },
          B: {
            type: 'linear',
            position: 'right',
            title: { display: true, text: 'Flow (q)' },
            grid: { drawOnChartArea: false }
          },
          x: { title: { display: true, text: 'Density (k)' } }
        }
      }
    });

    // Draw cars based on density
    function updateCars(k) {
      road.querySelectorAll('.car').forEach(car => car.remove());
      const laneCount = 2;
      const carsPerLane = Math.max(1, Math.floor(k / 5));
      const speed = uf * (1 - k / kj);
      for (let lane = 1; lane <= laneCount; lane++) {
        for (let i = 0; i < carsPerLane; i++) {
          const car = document.createElement('div');
          car.className = `car lane${lane}`;
          car.style.left = `${(i * 100 / carsPerLane)}%`;
          car.style.animation = `move${lane} ${10 / (speed / 20)}s linear infinite`;
          road.appendChild(car);
        }
      }
    }

    // Car animation styles
    const style = document.createElement('style');
    style.textContent = `
      @keyframes move1 {
        0% { left: -60px; }
        100% { left: 100%; }
      }
      @keyframes move2 {
        0% { left: -60px; }
        100% { left: 100%; }
      }
    `;
    document.head.appendChild(style);

    // Slider updates
    densitySlider.addEventListener('input', e => {
      const k = +e.target.value;
      densityValue.textContent = k;
      updateCars(k);
    });

    // Autoplay density slider
    let autoDir = 1;
    setInterval(() => {
      let val = +densitySlider.value + autoDir * 2;
      if (val >= 200) autoDir = -1;
      if (val <= 0) autoDir = 1;
      densitySlider.value = val;
      densitySlider.dispatchEvent(new Event('input'));
    }, 150);

    // Initialize
    updateCars(+densitySlider.value);
  </script>
</body>
</html>
