<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Greenshields Model — Interactive</title>
  <meta name="description" content="Interactive Greenshields fundamental diagram with animated vehicles and live plots (speed vs density, speed vs volume, volume vs density)." />
  <script src="https://cdn.plot.ly/plotly-2.26.1.min.js"></script>
  <style>
    :root{
      --bg: #f8fafc;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #0ea5e9;
      --accent-dark: #0284c7;
      --text: #0f172a;
      --shadow: 0 6px 18px rgba(2,6,23,0.08);
      --radius: 10px;
    }
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,#f8fafc, #eef2f7);
      color: var(--text);
      margin: 0;
      padding: 24px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    h1{font-size:20px;margin:0 0 10px}
    .layout {
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 18px;
      align-items: start;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(2,6,23,0.04);
    }
    .controls {
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .control-row { display:flex; gap:8px; align-items:center; }
    label { min-width:120px; color:var(--muted); font-size:13px; }
    input[type="range"] { width: 100%; }
    input[type="number"] { width:100px; padding:6px; border-radius:6px; border:1px solid #e6eef6; }
    #plots { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    #plots .plot { min-height:260px; background:transparent; }
    .road {
      width:100%;
      height:180px;
      border-radius:8px;
      background: linear-gradient(90deg,#e6eef6,#fff);
      display:block;
      position:relative;
      overflow:hidden;
      border:1px solid rgba(2,6,23,0.04);
    }
    .road-canvas { width:100%; height:100%; display:block; }
    .small { font-size:13px; color:var(--muted); }
    .controls .row-buttons { display:flex; gap:8px; }
    button {
      padding:8px 12px;
      border-radius:8px;
      border: none;
      background: var(--accent);
      color:white;
      cursor:pointer;
      font-weight:600;
    }
    button.secondary { background:#e6eef6; color:var(--accent-dark); font-weight:600; }
    .footer { margin-top:14px; font-size:13px; color:var(--muted); }
    @media (max-width: 980px){
      .layout { grid-template-columns: 1fr; }
      #plots { grid-template-columns: 1fr; }
    }
  </style>

  <!-- MathJax for LaTeX rendering -->
  <script>
    MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>

<body>
  <div style="max-width:1100px;margin:0 auto 18px;">
    <h1>TRAFFIC FLOW THEORY (Greenshields Fundamental Diagram)</h1>
    <div class="small">
      <p>
        Built for interactive demonstration of the <strong>Greenshields Traffic Flow Model</strong>.<br>
        You may use the demonstration for teaching or research purposes, but please cite as:<br>
        <em>Ollero, L. J. (2025). Traffic Flow Theory: Greenshields Model Interactive Visualization.</em><br>
        Available at: 
        <a href="https://lesterjayollero.github.io/TrafficFlowTheory.github.io" target="_blank">
          https://lesterjayollero.github.io/TrafficFlowTheory.github.io
        </a>
      </p>
    </div>
  </div>

  <div class="layout">
    <div class="card">
      <div id="plots">
        <div id="plot-uk" class="plot"></div>
        <div id="plot-uq" class="plot"></div>
        <div id="plot-qk" class="plot" style="grid-column: 1 / -1;"></div>
      </div>

      <div style="margin-top:12px" class="card">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div><strong>Road animation</strong><div class="small">Vehicles move around a closed loop.</div></div>
          <div class="small" id="status-density">Density: — veh/km</div>
        </div>
        <div class="road" id="road">
          <canvas id="roadCanvas" class="road-canvas"></canvas>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Model parameters</strong><div class="small">You may change free-flow speed &amp; jam density</div></div>
          <div><button id="resetBtn" class="secondary">Reset</button></div>
        </div>

        <div style="margin-top:10px">
          <div class="control-row">
            <label for="vf">Free-flow speed (v<sub>f</sub>)</label>
            <input id="vf" type="number" min="10" max="200" step="1" value="60"> <span class="small" style="margin-left:8px">km/hr</span>
          </div>

          <div class="control-row" style="margin-top:8px">
            <label for="kj">Jam density (k<sub>j</sub>)</label>
            <input id="kj" type="number" min="50" max="400" step="1" value="150"> <span class="small" style="margin-left:8px">veh/km</span>
          </div>

          <div class="control-row" style="margin-top:8px">
            <label for="roadLen">Road length</label>
            <input id="roadLen" type="number" min="0.1" max="10" step="0.1" value="1.0"> <span class="small" style="margin-left:8px">km</span>
          </div>
        </div>
      </div>

      <div class="card">
        <strong>Operating density</strong>
        <div class="small" style="margin-bottom:8px">Set the system density (vehicles per km). This controls vehicle count and operating point. <strong>Click Play to Demonstrate</strong></div>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="densityRange" type="range" min="0" max="150" step="1" value="20">
          <div style="width:70px;text-align:right"><input id="densityNumber" type="number" min="0" max="150" step="1" value="20"></div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <div class="row-buttons">
            <button id="playBtn">Play</button>
            <button id="pauseBtn" class="secondary">Pause</button>
          </div>
          <div style="margin-left:auto" class="small" id="oper-info">u = — km/hr • q = — veh/hr</div>
        </div>
      </div>
    </div>
  </div>

<script>
const plotUK = document.getElementById('plot-uk');
const plotUQ = document.getElementById('plot-uq');
const plotQK = document.getElementById('plot-qk');
const vfInput = document.getElementById('vf');
const kjInput = document.getElementById('kj');
const densityRange = document.getElementById('densityRange');
const densityNumber = document.getElementById('densityNumber');
const roadLenInput = document.getElementById('roadLen');
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');
const resetBtn = document.getElementById('resetBtn');
const operInfo = document.getElementById('oper-info');
const statusDensity = document.getElementById('status-density');
const roadCanvas = document.getElementById('roadCanvas');
const roadCtx = roadCanvas.getContext('2d');
const roadEl = document.getElementById('road');

let width = roadEl.clientWidth;
let height = roadEl.clientHeight;
roadCanvas.width = Math.floor(width * devicePixelRatio);
roadCanvas.height = Math.floor(height * devicePixelRatio);
roadCanvas.style.width = width + 'px';
roadCanvas.style.height = height + 'px';
roadCtx.scale(devicePixelRatio, devicePixelRatio);

let lastTime = performance.now();
let playAnimation = true;

// Default parameters
let vf = Number(vfInput.value);
let kj = Number(kjInput.value);
let roadLen = Number(roadLenInput.value);
let density = Number(densityRange.value);

function linspace(a,b,n){const out=[];const step=(b-a)/(n-1);for(let i=0;i<n;i++) out.push(a+step*i);return out;}
function greenshields_u(k, uf, kj){const u = uf*(1 - k/kj);return Math.max(0, u);}
function computeSeries(uf, kj){const ks=linspace(0,kj,201);const us=ks.map(k=>greenshields_u(k,uf,kj));const qs=ks.map((k,i)=>k*us[i]);return {ks,us,qs};}
let dataModel = computeSeries(vf, kj);

function drawPlots(){
  const { ks, us, qs } = dataModel;
  const curU = greenshields_u(density, vf, kj);
  const curQ = density * curU;
  Plotly.newPlot(plotUK,[{x:ks,y:us,mode:'lines',line:{color:'#0ea5e9'}},{x:[density],y:[curU],mode:'markers',marker:{size:10,color:'#034ea2'}}],{title:'Speed vs Density (u(k))',xaxis:{title:'k (veh/km)'},yaxis:{title:'u (km/hr)'},height:280},{displayModeBar:false});
  Plotly.newPlot(plotUQ,[{x:qs,y:us,mode:'lines',line:{color:'#0ea5e9'}},{x:[curQ],y:[curU],mode:'markers',marker:{size:10,color:'#034ea2'}}],{title:'Speed vs Volume (u(q))',xaxis:{title:'q (veh/hr)'},yaxis:{title:'u (km/hr)'},height:280},{displayModeBar:false});
  Plotly.newPlot(plotQK,[{x:ks,y:qs,mode:'lines',line:{color:'#0ea5e9'}},{x:[density],y:[curQ],mode:'markers',marker:{size:10,color:'#034ea2'}}],{title:'Volume vs Density (q(k))',xaxis:{title:'k (veh/km)'},yaxis:{title:'q (veh/hr)'},height:260},{displayModeBar:false});
}

function updatePlots(){
  const { ks, us, qs } = dataModel;
  const curU = greenshields_u(density, vf, kj);
  const curQ = density * curU;
  Plotly.react(plotUK,[{x:ks,y:us,mode:'lines',line:{color:'#0ea5e9'}},{x:[density],y:[curU],mode:'markers',marker:{size:10,color:'#034ea2'}}]);
  Plotly.react(plotUQ,[{x:qs,y:us,mode:'lines',line:{color:'#0ea5e9'}},{x:[curQ],y:[curU],mode:'markers',marker:{size:10,color:'#034ea2'}}]);
  Plotly.react(plotQK,[{x:ks,y:qs,mode:'lines',line:{color:'#0ea5e9'}},{x:[density],y:[curQ],mode:'markers',marker:{size:10,color:'#034ea2'}}]);
  operInfo.textContent = `v = ${curU.toFixed(2)} km/h • q = ${curQ.toFixed(1)} veh/h`;
  statusDensity.textContent = `Density: ${density.toFixed(0)} veh/km`;
}

let vehicles = [];
function recreateVehicles(){
  const N = Math.max(0, Math.round(density * roadLen));
  vehicles = [];
  for(let i=0;i<N;i++) vehicles.push({s:i/N,color:'#034ea2'});
}

function resizeCanvas(){
  width=roadEl.clientWidth;height=roadEl.clientHeight;
  roadCanvas.width=Math.floor(width*devicePixelRatio);
  roadCanvas.height=Math.floor(height*devicePixelRatio);
  roadCanvas.style.width=width+'px';
  roadCanvas.style.height=height+'px';
  roadCtx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
window.addEventListener('resize', resizeCanvas);

function drawRoad(){
  roadCtx.clearRect(0,0,width,height);
  const cx=width/2,cy=height/2,rx=width*0.42,ry=height*0.32;
  roadCtx.save();
  roadCtx.lineWidth=2;
  roadCtx.strokeStyle='rgba(2,6,23,0.06)';
  roadCtx.beginPath();
  roadCtx.ellipse(cx,cy,rx,ry,0,0,Math.PI*2);
  roadCtx.stroke();

  const curU_kmh = greenshields_u(density, vf, kj);
  const curU_ms = curU_kmh * 1000 / 3600;
  const a=rx,b=ry;
  const circumferencePx = Math.PI * (3*(a+b) - Math.sqrt((3*a + b)*(a + 3*b)));
  const meters=roadLen*1000;
  const dt=Math.min(0.04,(performance.now()-lastTime)/1000);
  lastTime=performance.now();

  for(let veh of vehicles){
    const distanceMeters=curU_ms*dt;
    const ds=(distanceMeters/meters);
    veh.s=(veh.s+ds)%1;
  }

  for(let veh of vehicles){
    const angle=veh.s*2*Math.PI;
    const x=cx+rx*Math.cos(angle);
    const y=cy+ry*Math.sin(angle);
    roadCtx.beginPath();
    roadCtx.fillStyle=veh.color;
    roadCtx.ellipse(x,y,6,4,0,0,Math.PI*2);
    roadCtx.fill();
  }
  roadCtx.restore();
}

function tick(){
  if(playAnimation) drawRoad();
  requestAnimationFrame(tick);
}

// Event listeners
densityRange.addEventListener('input', ()=>{density=Number(densityRange.value);densityNumber.value=density;updatePlots();recreateVehicles();});
densityNumber.addEventListener('change', ()=>{density=Number(densityNumber.value);densityRange.value=density;updatePlots();recreateVehicles();});
vfInput.addEventListener('change', ()=>{vf=Number(vfInput.value);dataModel=computeSeries(vf,kj);updatePlots();recreateVehicles();});
kjInput.addEventListener('change', ()=>{kj=Number(kjInput.value);densityRange.max=kj;densityNumber.max=kj;dataModel=computeSeries(vf,kj);updatePlots();recreateVehicles();});
roadLenInput.addEventListener('change', ()=>{roadLen=Number(roadLenInput.value);recreateVehicles();});
playBtn.addEventListener('click',()=>{playAnimation=true;});
pauseBtn.addEventListener('click',()=>{playAnimation=false;});
resetBtn.addEventListener('click',()=>{
  vfInput.value=60;kjInput.value=150;roadLenInput.value=1.0;
  vf=60;kj=150;roadLen=1.0;
  density=20;densityRange.value=20;densityNumber.value=20;
  dataModel=computeSeries(vf,kj);
  updatePlots();
  recreateVehicles();
});

drawPlots();
recreateVehicles();
tick();
</script>
</body>
</html>
