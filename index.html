<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Greenshields Model — Interactive Course Notes</title>
  <meta name="description" content="Interactive visualization of Greenshields' Traffic Flow Model with formulas, derivations, and animated simulation." />
  <script src="https://cdn.plot.ly/plotly-2.26.1.min.js"></script>
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #0ea5e9;
      --accent-dark: #0369a1;
      --text: #0f172a;
      --shadow: 0 6px 18px rgba(2,6,23,0.08);
      --radius: 10px;
    }
    body {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #f8fafc, #eef2f7);
      color: var(--text);
      margin: 0;
      padding: 24px;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    h1, h2 { color: var(--accent-dark); margin-bottom: 8px; }
    h1 { font-size: 22px; }
    h2 { font-size: 18px; margin-top: 20px; }
    p { margin: 8px 0; }
    code { background: #e2e8f0; padding: 2px 6px; border-radius: 4px; }
    a { color: var(--accent-dark); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .layout {
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 18px;
      align-items: start;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(2,6,23,0.04);
    }
    #plots { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    #plots .plot { min-height: 260px; }
    .road {
      width: 100%;
      height: 180px;
      border-radius: 8px;
      background: linear-gradient(180deg, #9ca3af 10%, #4b5563 10%, #4b5563 90%, #9ca3af 90%);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(2,6,23,0.04);
    }
    .lane-line {
      position: absolute;
      width: 100%;
      height: 4px;
      background: repeating-linear-gradient(90deg, #f8fafc 0 20px, transparent 20px 40px);
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.7;
    }
    canvas.road-canvas { position: absolute; top: 0; left: 0; }
    .controls { display: flex; flex-direction: column; gap: 12px; }
    button {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      background: var(--accent);
      color: white;
      cursor: pointer;
      font-weight: 600;
    }
    button.secondary { background: #e6eef6; color: var(--accent-dark); }
    .small { font-size: 13px; color: var(--muted); }
    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
      #plots { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <div style="max-width:1100px;margin:0 auto 24px;">
    <h1>Traffic Flow Theory — Greenshields Model (Interactive Demonstration)</h1>
    <p>
      The <strong>Greenshields Model (1935)</strong> is the earliest and most fundamental
      relationship in traffic flow theory. It assumes a <em>linear relationship</em> between
      vehicle speed and traffic density. From this assumption, we can derive the three fundamental
      diagrams that describe the behavior of a traffic stream.
    </p>

    <h2>1. Fundamental Relationships</h2>
    <p>
      Let <code>v</code> = speed (km/h), <code>k</code> = density (veh/km), and
      <code>q</code> = flow or volume (veh/h).
    </p>
    <p>
      According to Greenshields’ linear assumption:
      <br>
      <code>v = v<sub>f</sub>(1 - k / k<sub>j</sub>)</code>
    </p>
    <p>
      where <code>v<sub>f</sub></code> is the <strong>free-flow speed</strong> (speed at zero density),
      and <code>k<sub>j</sub></code> is the <strong>jam density</strong> (density at zero speed).
    </p>

    <h2>2. Derived Relationships</h2>
    <p>
      Substituting into <code>q = k × v</code> gives:
      <br>
      <code>q = v<sub>f</sub> × (k - k² / k<sub>j</sub>)</code>
    </p>
    <p>
      Maximum flow <code>q<sub>max</sub></code> occurs when <code>dq/dk = 0</code>,
      yielding:
      <br>
      <code>k = k<sub>j</sub> / 2</code> and <code>q<sub>max</sub> = v<sub>f</sub>k<sub>j</sub> / 4</code>.
    </p>

    <h2>3. Assumptions</h2>
    <ul>
      <li>Uniform traffic composition (all vehicles are similar).</li>
      <li>Steady-state conditions (no acceleration or stop-and-go waves).</li>
      <li>One-dimensional flow (single direction, homogeneous stream).</li>
    </ul>

    <p class="small">
      <em>References:</em>  
      <br>• Greenshields, B.D. (1935). “A Study of Traffic Capacity.” *Highway Research Board Proceedings*, Vol. 14.  
      <br>• May, A.D. (1990). *Traffic Flow Fundamentals*. Prentice Hall.  
      <br>• TRB Highway Capacity Manual (HCM), latest edition.
    </p>
  </div>

  <div class="layout">
    <div class="card">
      <div id="plots">
        <div id="plot-vk" class="plot"></div>
        <div id="plot-vq" class="plot"></div>
        <div id="plot-qk" class="plot" style="grid-column: 1 / -1;"></div>
      </div>

      <div style="margin-top:12px" class="card">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div><strong>Road Animation</strong><div class="small">Straight 2-lane, one-way traffic stream</div></div>
          <div class="small" id="status-density">Density: — veh/km</div>
        </div>

        <div class="road" id="road">
          <div class="lane-line"></div>
          <canvas id="roadCanvas" class="road-canvas"></canvas>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="card">
        <strong>Model Parameters</strong>
        <div class="control-row">
          <label for="vf">Free-flow speed</label>
          <input id="vf" type="number" min="10" max="200" value="60"> km/h
        </div>
        <div class="control-row">
          <label for="kj">Jam density</label>
          <input id="kj" type="number" min="50" max="400" value="150"> veh/km
        </div>
        <div class="control-row">
          <label for="roadLen">Road length</label>
          <input id="roadLen" type="number" min="0.1" max="10" step="0.1" value="1.0"> km
        </div>
      </div>

      <div class="card">
        <strong>Operating Density</strong>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="densityRange" type="range" min="0" max="150" step="1" value="20">
          <input id="densityNumber" type="number" min="0" max="150" step="1" value="20">
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <button id="playBtn">Play</button>
          <button id="pauseBtn" class="secondary">Pause</button>
          <div style="margin-left:auto" class="small" id="oper-info">v = — km/h • q = — veh/h</div>
        </div>
      </div>
    </div>
  </div>

  <script>
  // Greenshields model + animation (straight road, 2 lanes)
  const plotVK = document.getElementById('plot-vk');
  const plotVQ = document.getElementById('plot-vq');
  const plotQK = document.getElementById('plot-qk');
  const vfInput = document.getElementById('vf');
  const kjInput = document.getElementById('kj');
  const densityRange = document.getElementById('densityRange');
  const densityNumber = document.getElementById('densityNumber');
  const playBtn = document.getElementById('playBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const roadCanvas = document.getElementById('roadCanvas');
  const roadCtx = roadCanvas.getContext('2d');
  const roadEl = document.getElementById('road');
  const operInfo = document.getElementById('oper-info');
  const statusDensity = document.getElementById('status-density');

  let vf = Number(vfInput.value), kj = Number(kjInput.value), density = Number(densityRange.value), roadLen = 1.0;
  let playAnimation = true, vehicles = [], lastTime = performance.now();

  function greenshields_v(k, vf, kj){ return Math.max(0, vf*(1 - k/kj)); }
  function computeSeries(vf, kj){ const ks=[...Array(201).keys()].map(i=>i*kj/200); const vs=ks.map(k=>greenshields_v(k,vf,kj)); const qs=ks.map((k,i)=>k*vs[i]); return {ks,vs,qs}; }

  let dataModel = computeSeries(vf,kj);
  function drawPlots(){
    const {ks,vs,qs}=dataModel; const curV=greenshields_v(density,vf,kj); const curQ=density*curV;
    Plotly.newPlot(plotVK,[{x:ks,y:vs,mode:'lines',line:{color:'#0ea5e9'}},{x:[density],y:[curV],mode:'markers',marker:{size:10,color:'#034ea2'}}],
      {title:'Speed vs Density',xaxis:{title:'k (veh/km)'},yaxis:{title:'v (km/h)'},height:260},{displayModeBar:false});
    Plotly.newPlot(plotVQ,[{x:qs,y:vs,mode:'lines',line:{color:'#0ea5e9'}},{x:[curQ],y:[curV],mode:'markers',marker:{size:10,color:'#034ea2'}}],
      {title:'Speed vs Volume',xaxis:{title:'q (veh/h)'},yaxis:{title:'v (km/h)'},height:260},{displayModeBar:false});
    Plotly.newPlot(plotQK,[{x:ks,y:qs,mode:'lines',line:{color:'#0ea5e9'}},{x:[density],y:[curQ],mode:'markers',marker:{size:10,color:'#034ea2'}}],
      {title:'Volume vs Density',xaxis:{title:'k (veh/km)'},yaxis:{title:'q (veh/h)'},height:260},{displayModeBar:false});
    operInfo.textContent=`v = ${curV.toFixed(1)} km/h • q = ${curQ.toFixed(1)} veh/h`;
    statusDensity.textContent=`Density: ${density.toFixed(0)} veh/km`;
  }
  drawPlots();

  function recreateVehicles(){
    const N=Math.max(1,Math.round(density*roadLen));
    vehicles=[];
    for(let i=0;i<N;i++){
      vehicles.push({x:(i/N)*roadEl.clientWidth,y:(i%2===0)?roadEl.clientHeight/2-20:roadEl.clientHeight/2+20});
    }
  }
  recreateVehicles();

  function drawRoad(){
    roadCtx.clearRect(0,0,roadEl.clientWidth,roadEl.clientHeight);
    const curV=greenshields_v(density,vf,kj)*1000/3600;
    const dt=Math.min(0.05,(performance.now()-lastTime)/1000); lastTime=performance.now();
    for(let veh of vehicles){
      veh.x += curV*dt*2;
      if(veh.x>roadEl.clientWidth+20) veh.x=-20;
      roadCtx.fillStyle="#034ea2";
      roadCtx.fillRect(veh.x,veh.y-6,12,12);
    }
  }
  function animate(){ if(playAnimation) drawRoad(); requestAnimationFrame(animate); }
  animate();

  densityRange.addEventListener('input',()=>{density=+densityRange.value; densityNumber.value=density; drawPlots(); recreateVehicles();});
  densityNumber.addEventListener('change',()=>{density=+densityNumber.value; densityRange.value=density; drawPlots(); recreateVehicles();});
  vfInput.addEventListener('change',()=>{vf=+vfInput.value; dataModel=computeSeries(vf,kj); drawPlots();});
  kjInput.addEventListener('change',()=>{kj=+kjInput.value; dataModel=computeSeries(vf,kj); drawPlots();});
  playBtn.addEventListener('click',()=>{playAnimation=true;});
  pauseBtn.addEventListener('click',()=>{playAnimation=false;});
  </script>
</body>
</html>
